import os
import requests
import random
from datetime import datetime, timezone
from openai import OpenAI

# ç’°å¢ƒå¤‰æ•°
OPENAI_API_KEY = os.environ["OPENAI_API_KEY"]
IFTTT_URL = os.environ["IFTTT_URL"]

client = OpenAI(api_key=OPENAI_API_KEY)

# ãƒ©ãƒ³ãƒ€ãƒ ãƒ†ãƒ¼ãƒï¼ˆ30é …ç›®ä»¥ä¸Šï¼‰
THEMES = [
    "è‡ªå·±è‚¯å®šæ„Ÿã‚’é«˜ã‚ã‚‹è¨€è‘‰",
    "ä¸€æ­©è¸ã¿å‡ºã™å‹‡æ°—ã‚’ä¸ãˆã‚‹è¨€è‘‰",
    "åœ¨å®…ã§ã§ãã‚‹å‰¯æ¥­ã‚„åå…¥ã®ã‚¢ã‚¤ãƒ‡ã‚¢",
    "å¿ƒã‚’è»½ãã™ã‚‹ãƒ¡ãƒ³ã‚¿ãƒ«ã‚±ã‚¢ã®çŸ¥æµ",
    "å¼•ãã“ã‚‚ã‚ŠçµŒé¨“ã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹å¼·ã¿",
    "å®‰å¿ƒã§ãã‚‹æ—¥å¸¸ã®å·¥å¤«",
    "äººã¨ã®ã¤ãªãŒã‚Šæ–¹ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸­å¿ƒï¼‰",
    "å¤–ã«å‡ºãªãã¦ã‚‚æ¥½ã—ã‚ã‚‹è¶£å‘³",
    "å°ã•ãªæˆåŠŸä½“é¨“ã®ç©ã¿é‡ã­",
    "è‡ªåˆ†ã‚’è²¬ã‚ãšã«ä¼‘ã‚€å¤§åˆ‡ã•",
    "ã‚¹ãƒˆãƒ¬ã‚¹ã‚’å’Œã‚‰ã’ã‚‹å‘¼å¸æ³•ã‚„ãƒªãƒ©ãƒƒã‚¯ã‚¹æ³•",
    "å¼•ãã“ã‚‚ã‚Šã§ã‚‚ã§ãã‚‹å¥åº·ç¿’æ…£ï¼ˆè»½ã„é‹å‹•ãªã©ï¼‰",
    "å­¤ç‹¬æ„Ÿã‚’å’Œã‚‰ã’ã‚‹è€ƒãˆæ–¹",
    "å¼•ãã“ã‚‚ã‚Šã‚’ãƒã‚¸ãƒ†ã‚£ãƒ–ã«æ‰ãˆã‚‹è¦–ç‚¹",
    "ãŠé‡‘ã‚’ã‹ã‘ãšã«æ¥½ã—ã‚ã‚‹å·¥å¤«",
    "å¿ƒãŒè½ã¡è¾¼ã‚“ã æ™‚ã®ç«‹ã¡ç›´ã‚Šæ–¹",
    "å¼•ãã“ã‚‚ã‚Šã‚’æ´»ã‹ã—ãŸå‰µä½œæ´»å‹•ã®ã™ã™ã‚",
    "ç„¡ç†ã›ãšã§ãã‚‹å‹‰å¼·ã‚„ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—",
    "ä¸€äººæš®ã‚‰ã—ã§ã‚‚å¿ƒåœ°ã‚ˆãéã”ã™å·¥å¤«",
    "å°ã•ãªã”è¤’ç¾ã§è‡ªåˆ†ã‚’å¤§åˆ‡ã«ã™ã‚‹æ–¹æ³•",
    "AIã‚„æœ€æ–°ãƒ„ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ãŸä¾¿åˆ©ãªæš®ã‚‰ã—",
    "åœ¨å®…ã§ã§ãã‚‹ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã‚„ç¤¾ä¼šå‚åŠ ",
    "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§å®‰å¿ƒã—ã¦è©±ã›ã‚‹å±…å ´æ‰€",
    "ã€Œä¼‘ã‚€ã“ã¨ã€ã‚’è‚¯å®šã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
    "å¤±æ•—ã‚’æ°—ã«ã—ãªã„ç”Ÿãæ–¹ã®ãƒ’ãƒ³ãƒˆ",
    "å°ã•ãªæŒ‘æˆ¦ã®ç©ã¿é‡ã­ãŒå¤§ããªæˆæœã«ãªã‚‹è©±",
    "è‡ªåˆ†ã ã‘ã®ãƒšãƒ¼ã‚¹ã‚’å®ˆã‚‹å¤§åˆ‡ã•",
    "å¼•ãã“ã‚‚ã‚Šã‹ã‚‰è¦‹ãˆã‚‹ç¤¾ä¼šã¸ã®æ°—ã¥ã",
    "å¿ƒã«å¯„ã‚Šæ·»ã†åè¨€ã‚„ã“ã¨ã°",
    "ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’æ•´ãˆã‚‹å°ã•ãªå·¥å¤«",
    "éƒ¨å±‹ã‚’å¿«é©ã«ã™ã‚‹ãƒ—ãƒæ¨¡æ§˜æ›¿ãˆã®ææ¡ˆ",
    "ç¡çœ ã‚’æ•´ãˆã‚‹ç¿’æ…£",
    "å­¤ç‹¬æ„Ÿã‚’æ¸›ã‚‰ã™ãƒšãƒƒãƒˆã‚„æ¤ç‰©ã®å­˜åœ¨",
    "åœ¨å®…ã§ã®åå…¥æºã®æœ€æ–°æƒ…å ±",
    "è‡ªåˆ†ã‚’ç™’ã™ã‚»ãƒ«ãƒ•ã‚±ã‚¢ã®æ–¹æ³•",
    "å¼•ãã“ã‚‚ã‚Šã®ãƒã‚ºã‚‹ä¸€è¨€",
]

SYSTEM_PROMPT = (
    "ã‚ãªãŸã¯ã€å¼•ãã“ã‚‚ã‚Šã®äººã«å¯„ã‚Šæ·»ã„åŠ±ã¾ã™ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ã€ã§ã™ã€‚\n"
    "æ¯æ—¥ã€å¼•ãã“ã‚‚ã‚Šã®äººã«å‘ã‘ã¦æœ‰ç›Šãªæƒ…å ±ãƒ»æ°—ã¥ããƒ»è¨€è‘‰ã‚’Xï¼ˆæ—§Twitterï¼‰å‘ã‘ã«ç™ºä¿¡ã—ã¦ãã ã•ã„ã€‚\n"
    "æ—¥æœ¬èªã§140å­—ä»¥å†…ã€çµµæ–‡å­—ã¯0ã€œ2å€‹ã¾ã§ã€‚èª¤æƒ…å ±ãƒ»ç…½ã‚Šã¯ç¦æ­¢ã€‚\n"
    "é›£ã—ã™ããšã€å„ªã—ãèªã‚Šã‹ã‘ã‚‹æ–‡ä½“ã§ã€‚"
)

def generate_tweet() -> str:
    today = datetime.now().strftime("%Yå¹´%mæœˆ%dæ—¥")
    theme = random.choice(THEMES)  # ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ†ãƒ¼ãƒé¸æŠ
    user_prompt = (
        f"{today}ã«æŠ•ç¨¿ã™ã‚‹ã€å¼•ãã“ã‚‚ã‚Šã®äººã«æœ‰ç›Šãªå†…å®¹ã‚’è€ƒãˆã¦ãã ã•ã„ã€‚\n"
        f"ãƒ†ãƒ¼ãƒã¯ã€{theme}ã€ã§ã™ã€‚\n"
        "Xå‘ã‘ã«140å­—ä»¥å†…ã€æ—¥æœ¬èªã§æ›¸ã„ã¦ãã ã•ã„ã€‚"
    )
    res = client.chat.completions.create(
        model="gpt-4",
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_prompt},
        ],
        max_tokens=280,
        temperature=0.9,
    )
    tweet = res.choices[0].message.content.strip()
    tweet = " ".join(tweet.split())
    if len(tweet) > 140:
        tweet = tweet[:137] + "â€¦"
    return tweet

def post_to_ifttt(text: str):
    r = requests.post(IFTTT_URL, json={"value1": text}, timeout=15)
    r.raise_for_status()
    return r.text

def main():
    print("ğŸ§  GPTãŒãƒ©ãƒ³ãƒ€ãƒ ãƒ†ãƒ¼ãƒã§å¼•ãã“ã‚‚ã‚Šå‘ã‘ãƒ„ã‚¤ãƒ¼ãƒˆç”Ÿæˆä¸­...")
    tweet = generate_tweet()
    print("ğŸ¦ æŠ•ç¨¿å†…å®¹:", tweet)
    resp = post_to_ifttt(tweet)
    now = datetime.now(timezone.utc).isoformat()
    print(f"[{now}] âœ… IFTTTçµŒç”±ã§æŠ•ç¨¿å®Œäº†:", resp)

if __name__ == "__main__":
    main()
